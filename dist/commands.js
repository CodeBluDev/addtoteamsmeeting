/*! For license information please see commands.js.LICENSE.txt */
!function(){function e(){var n,r,o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",i=o.toStringTag||"@@toStringTag";function c(e,o,a,i){var c=o&&o.prototype instanceof u?o:u,f=Object.create(c.prototype);return t(f,"_invoke",function(e,t,o){var a,i,c,u=0,f=o||[],l=!1,d={p:0,n:0,v:n,a:m,f:m.bind(n,4),d:function(e,t){return a=e,i=0,c=n,d.n=t,s}};function m(e,t){for(i=e,c=t,r=0;!l&&u&&!o&&r<f.length;r++){var o,a=f[r],m=d.p,p=a[2];e>3?(o=p===t)&&(c=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=n):a[0]<=m&&((o=e<2&&m<a[1])?(i=0,d.v=t,d.n=a[1]):m<p&&(o=e<3||a[0]>t||t>p)&&(a[4]=e,a[5]=t,d.n=p,i=0))}if(o||e>1)return s;throw l=!0,t}return function(o,f,p){if(u>1)throw TypeError("Generator is already running");for(l&&1===f&&m(f,p),i=f,c=p;(r=i<2?n:c)||!l;){a||(i?i<3?(i>1&&(d.n=-1),m(i,c)):d.n=c:d.v=c);try{if(u=2,a){if(i||(o="next"),r=a[o]){if(!(r=r.call(a,c)))throw TypeError("iterator result is not an object");if(!r.done)return r;c=r.value,i<2&&(i=0)}else 1===i&&(r=a.return)&&r.call(a),i<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),i=1);a=n}else if((r=(l=d.n<0)?c:e.call(t,d))!==s)break}catch(e){a=n,i=1,c=e}finally{u=1}}return{value:r,done:l}}}(e,a,i),!0),f}var s={};function u(){}function f(){}function l(){}r=Object.getPrototypeOf;var d=[][a]?r(r([][a]())):(t(r={},a,function(){return this}),r),m=l.prototype=u.prototype=Object.create(d);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,l):(e.__proto__=l,t(e,i,"GeneratorFunction")),e.prototype=Object.create(m),e}return f.prototype=l,t(m,"constructor",l),t(l,"constructor",f),f.displayName="GeneratorFunction",t(l,i,"GeneratorFunction"),t(m),t(m,i,"Generator"),t(m,a,function(){return this}),t(m,"toString",function(){return"[object Generator]"}),(e=function(){return{w:c,m:p}})()}function t(e,n,r,o){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}t=function(e,n,r,o){function i(n,r){t(e,n,function(e){return this._invoke(n,r,e)})}n?a?a(e,n,{value:r,enumerable:!o,configurable:!o,writable:!o}):e[n]=r:(i("next",0),i("throw",1),i("return",2))},t(e,n,r,o)}function n(e){return function(e){if(Array.isArray(e))return r(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return r(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function o(e,t,n,r,o,a,i){try{var c=e[a](i),s=c.value}catch(e){return void n(e)}c.done?t(s):Promise.resolve(s).then(r,o)}function a(e){return function(){var t=this,n=arguments;return new Promise(function(r,a){var i=e.apply(t,n);function c(e){o(i,r,a,c,s,"next",e)}function s(e){o(i,r,a,c,s,"throw",e)}c(void 0)})}}Office.onReady(function(){});var i="Icon.16x16",c="https://graph.microsoft.com/v1.0",s=["https://graph.microsoft.com/Calendars.ReadWrite"],u=null,f=0;function l(e){e.notificationMessages.replaceAsync("success",{type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,icon:i,persistent:!1,message:"Teams meeting link added to Location. (".concat("v1.8.2"," | ").concat("2024-09-18T16:40Z",")")})}function d(e,t){e.notificationMessages.replaceAsync("error",{type:Office.MailboxEnums.ItemNotificationMessageType.ErrorMessage,message:t})}function m(e,t){e.notificationMessages.replaceAsync("info",{type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,icon:i,persistent:!1,message:t})}function p(e,t){var n=e.subject||"Teams meeting";Office.context.ui.displayDialogAsync("https://codebludev.github.io/addtoteamsmeeting/create-event.html?v=1.8.2",{height:55,width:35,displayInIframe:!0},function(r){if(r.status===Office.AsyncResultStatus.Succeeded){var o=r.value;o.addEventHandler(Office.EventType.DialogMessageReceived,function(r){var a;try{a=JSON.parse(r.message)}catch(t){return d(e,"Invalid response from dialog."),void o.close()}if("cancel"!==a.action){if("create"!==a.action)return d(e,"Unknown dialog response."),void o.close();var i=new Date(a.start),c=new Date(a.end);if(Number.isNaN(i.valueOf())||Number.isNaN(c.valueOf()))return d(e,"Invalid date/time from dialog."),void o.close();Office.context.mailbox.displayNewAppointmentForm({subject:a.subject||n,location:t,start:i,end:c}),o.close(),l(e)}else o.close()}),o.addEventHandler(Office.EventType.DialogEventReceived,function(){m(e,"Event dialog closed.")}),o.messageChild(JSON.stringify({subject:n,teamsLink:t}))}else d(e,"Unable to open the event dialog.")})}function g(){return(g=a(e().m(function t(n,r){var o,a,i,s,u,f,l,d,m;return e().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,h();case 1:o=e.v,a=new Date,i=new Date(a.getTime()+7776e6),s="".concat(c,"/me/calendarView?startDateTime=").concat(encodeURIComponent(a.toISOString()),"&endDateTime=").concat(encodeURIComponent(i.toISOString()))+"&$select=id,subject,body,location,onlineMeetingUrl,start,end";case 2:if(!s){e.n=10;break}return e.n=3,fetch(s,{headers:{Authorization:"Bearer ".concat(o),Prefer:'outlook.body-content-type="text"'}});case 3:if((u=e.v).ok){e.n=5;break}return e.n=4,u.text();case 4:throw f=e.v,new Error("Graph calendarView failed: ".concat(u.status," ").concat(f));case 5:return e.n=6,u.json();case 6:l=e.v,d=l.value||[],m=0;case 7:if(!(m<d.length)){e.n=9;break}if(!b(d[m],n,r)){e.n=8;break}return e.a(2,d[m].id);case 8:m+=1,e.n=7;break;case 9:s=l["@odata.nextLink"]||null,e.n=2;break;case 10:return e.a(2,null)}},t)}))).apply(this,arguments)}function v(){return(v=a(e().m(function t(n,r){var o,a,i;return e().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,h();case 1:return o=e.v,e.n=2,fetch("".concat(c,"/me/events/").concat(n),{method:"PATCH",headers:{Authorization:"Bearer ".concat(o),"Content-Type":"application/json"},body:JSON.stringify({location:{displayName:r}})});case 2:if((a=e.v).ok){e.n=4;break}return e.n=3,a.text();case 3:throw i=e.v,new Error("Graph update failed: ".concat(a.status," ").concat(i));case 4:return e.a(2)}},t)}))).apply(this,arguments)}function h(){return y.apply(this,arguments)}function y(){return(y=a(e().m(function t(){var n,r;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:if(!(u&&Date.now()<f)){e.n=1;break}return e.a(2,u);case 1:if(!(OfficeRuntime&&OfficeRuntime.auth&&OfficeRuntime.auth.getAccessToken)){e.n=5;break}return e.p=2,e.n=3,OfficeRuntime.auth.getAccessToken({allowSignInPrompt:!0,allowConsentPrompt:!0,forMSGraphAccess:!0});case 3:return n=e.v,I("Graph token acquired (OfficeRuntime)"),O(n,50),e.a(2,n);case 4:e.p=4,I("OfficeRuntime auth failed",{message:e.v.message});case 5:return e.n=6,w();case 6:return r=e.v,I("Graph token acquired (dialog)"),O(r,45),e.a(2,r)}},t,null,[[2,4]])}))).apply(this,arguments)}function b(e,t,n){var r=e.body&&e.body.content?e.body.content:"",o=e.onlineMeetingUrl||"";return!(!n||!r.includes(n)&&!o.includes(n))||!(!t||!r.includes(t)&&!o.includes(t))}function O(e,t){u=e,f=Date.now()+60*t*1e3}function w(){return new Promise(function(e,t){Office.context.ui.displayDialogAsync("https://codebludev.github.io/addtoteamsmeeting/auth.html?v=1.8.2",{height:60,width:40,displayInIframe:!0},function(n){if(n.status===Office.AsyncResultStatus.Succeeded){var r=n.value;r.addEventHandler(Office.EventType.DialogMessageReceived,function(n){var o;try{o=JSON.parse(n.message)}catch(e){return r.close(),void t(new Error("Invalid auth dialog response."))}if("token"===o.type&&o.accessToken)return r.close(),void e(o.accessToken);r.close(),t(new Error(o.message||"Auth failed."))}),r.addEventHandler(Office.EventType.DialogEventReceived,function(){t(new Error("Auth dialog closed."))}),r.messageChild(JSON.stringify({clientId:"226fcb0c-fa77-48bb-a20e-70a75ce176fd",authority:"https://login.microsoftonline.com/organizations",scopes:s}))}else t(new Error("Unable to open auth dialog."))})})}function k(e){var t=e.replace(/&amp;/g,"&");if(/%[0-9A-Fa-f]{2}/.test(t))try{return decodeURIComponent(t)}catch(e){return t}return t}function T(e){return e.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'")}function A(e){try{var t=new URL(e).searchParams.get("url");return t?decodeURIComponent(t):null}catch(e){return null}}function I(e,t){t?console.log("[AddTeamsLink] ".concat(e),t):console.log("[AddTeamsLink] ".concat(e))}Office.actions.associate("addTeamsLinkToLocation",function(e){var t=Office.context.mailbox.item;I("Command invoked",{itemId:t.itemId,itemType:t.itemType}),t.body.getAsync(Office.CoercionType.Html,function(r){if(I("Body getAsync result",{status:r.status}),r.status!==Office.AsyncResultStatus.Succeeded)return t.notificationMessages.replaceAsync("error",{type:Office.MailboxEnums.ItemNotificationMessageType.ErrorMessage,message:"Unable to read message body."}),void e.completed();var o=r.value,a=function(e){var t=/https:\/\/teams\.microsoft\.com\/l\/meetup-join\/[^\s"<]+/i,r=/https:\/\/[^\/]+\.safelinks\.protection\.outlook\.com\/[^\s"<]+/i,o=/https:\/\/aka\.ms\/[^\s"<]*teams[^\s"<]*/i,a=function(e){var t=[],r=e.match(/https:\/\/teams\.microsoft\.com\/l\/meetup-join\/[^\s"'<>]+/gi);r&&t.push.apply(t,n(r));var o=T(e).match(/https:\/\/teams\.microsoft\.com\/l\/meetup-join\/[^\s"'<>]+/gi);o&&t.push.apply(t,n(o));for(var a=0;a<t.length;a+=1){var i=k(t[a]);if(i)return i}return null}(e);if(a)return a;for(var i=e.match(/https?:\/\/[^\s"'<>]+/gi)||[],c=0;c<i.length;c+=1){var s=i[c].replace(/&amp;/g,"&");if(t.test(s))return k(s);if(r.test(s)){var u=A(s);if(u){var f=k(u);if(t.test(f))return f}}if(o.test(s))return s}return null}(o);if(I("Teams link match",{found:Boolean(a)}),!a)return m(t,"No Microsoft Teams meeting link found in this invite."),void e.completed();I("Teams link extracted",{teamsLink:a});var i=function(e,t){if(t){var n=t.match(/19:meeting_[^/?"'\\s<>]+/i);if(n)return n[0]}var r="".concat(e," ").concat(t||""),o=T(k(r)).match(/19:meeting_[^/?"'\\s<>]+/i);if(o)return o[0];var a=r.match(/19%3Ameeting_[^"'\\s<>%]+/i);return a?k(a[0]):null}(o,a);I("Meeting id extracted",{meetingId:i}),function(e,t){return g.apply(this,arguments)}(a,i).then(function(n){return n?function(e,t){return v.apply(this,arguments)}(n,a).then(function(){return l(t),e.completed(),null}).catch(function(n){return I("Graph update failed",{message:n.message}),d(t,"Unable to update the calendar location."),e.completed(),null}):(m(t,"No matching calendar event found. Opening event dialog."),p(t,a),e.completed(),null)}).catch(function(n){I("Graph search failed",{message:n.message}),m(t,"Opening event dialog (calendar search blocked)."),p(t,a),e.completed()})})})}();
//# sourceMappingURL=commands.js.map