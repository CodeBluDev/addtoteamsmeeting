!function(){function e(e){return function(e){if(Array.isArray(e))return t(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,n){if(e){if("string"==typeof e)return t(e,n);var a={}.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?t(e,n):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function t(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=Array(t);n<t;n++)a[n]=e[n];return a}Office.onReady(function(){});var n="http://schemas.microsoft.com/exchange/services/2006/messages",a="http://schemas.microsoft.com/exchange/services/2006/types",o="Icon.16x16";function r(e){e.notificationMessages.replaceAsync("success",{type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,icon:o,persistent:!1,message:"Teams meeting link added to Location. (".concat("v1.8.2"," | ").concat("2024-09-18T16:40Z",")")})}function s(e,t){e.notificationMessages.replaceAsync("error",{type:Office.MailboxEnums.ItemNotificationMessageType.ErrorMessage,message:t})}function i(e,t){e.notificationMessages.replaceAsync("info",{type:Office.MailboxEnums.ItemNotificationMessageType.InformationalMessage,icon:o,persistent:!1,message:t})}function c(e,t){var n=e.subject||"Teams meeting";Office.context.ui.displayDialogAsync("https://127.0.0.1:3000/create-event.html?v=1.8.2",{height:55,width:35,displayInIframe:!0},function(a){if(a.status===Office.AsyncResultStatus.Succeeded){var o=a.value;o.addEventHandler(Office.EventType.DialogMessageReceived,function(a){var i;try{i=JSON.parse(a.message)}catch(t){return s(e,"Invalid response from dialog."),void o.close()}if("cancel"!==i.action){if("create"!==i.action)return s(e,"Unknown dialog response."),void o.close();var c=new Date(i.start),l=new Date(i.end);if(Number.isNaN(c.valueOf())||Number.isNaN(l.valueOf()))return s(e,"Invalid date/time from dialog."),void o.close();Office.context.mailbox.displayNewAppointmentForm({subject:i.subject||n,location:t,start:c,end:l}),o.close(),r(e)}else o.close()}),o.addEventHandler(Office.EventType.DialogEventReceived,function(){i(e,"Event dialog closed.")}),o.messageChild(JSON.stringify({subject:n,teamsLink:t}))}else s(e,"Unable to open the event dialog.")})}function l(e,t,o){var r=f(t);y("EWS UpdateItem request prepared",{itemId:e.id});var s='<?xml version="1.0" encoding="utf-8"?>\n<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"\n               xmlns:t="'.concat(a,'"\n               xmlns:m="').concat(n,'">\n  <soap:Header>\n    <t:RequestServerVersion Version="Exchange2013" />\n  </soap:Header>\n  <soap:Body>\n    <m:UpdateItem ConflictResolution="AlwaysOverwrite" SendMeetingInvitationsOrCancellations="SendToNone">\n      <m:ItemChanges>\n        <t:ItemChange>\n          <t:ItemId Id="').concat(e.id,'" ChangeKey="').concat(e.changeKey,'" />\n          <t:Updates>\n            <t:SetItemField>\n              <t:FieldURI FieldURI="calendar:Location" />\n              <t:CalendarItem>\n                <t:Location>').concat(r,"</t:Location>\n              </t:CalendarItem>\n            </t:SetItemField>\n          </t:Updates>\n        </t:ItemChange>\n      </m:ItemChanges>\n    </m:UpdateItem>\n  </soap:Body>\n</soap:Envelope>");Office.context.mailbox.makeEwsRequestAsync(s,function(e){if(y("EWS UpdateItem response",{status:e.status,error:e.error?{name:e.error.name,message:e.error.message}:null}),e.status===Office.AsyncResultStatus.Succeeded){var t=d(e.value);t&&u(t)?o(null):o(new Error("EWS UpdateItem failed."))}else o(e.error)})}function m(e,t,n){return Math.abs(e-n.start)<=6e4&&Math.abs(t-n.end)<=6e4}function d(e){return e?(new DOMParser).parseFromString(e,"text/xml"):null}function u(e){var t=e.getElementsByTagNameNS(n,"ResponseCode")[0];return t&&"NoError"===t.textContent}function f(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function p(e){var t=e.replace(/&amp;/g,"&");if(/%[0-9A-Fa-f]{2}/.test(t))try{return decodeURIComponent(t)}catch(e){return t}return t}function g(e){try{var t=new URL(e).searchParams.get("url");return t?decodeURIComponent(t):null}catch(e){return null}}function v(e){if(!e)return"Unknown error";var t=e.name||"EWS error",n=e.message||"No message";return"".concat(t,": ").concat(n)}function y(e,t){t?console.log("[AddTeamsLink] ".concat(e),t):console.log("[AddTeamsLink] ".concat(e))}Office.actions.associate("addTeamsLinkToLocation",function(t){var o=Office.context.mailbox.item;y("Command invoked",{itemId:o.itemId,itemType:o.itemType}),o.body.getAsync(Office.CoercionType.Html,function(h){if(y("Body getAsync result",{status:h.status}),h.status!==Office.AsyncResultStatus.Succeeded)return o.notificationMessages.replaceAsync("error",{type:Office.MailboxEnums.ItemNotificationMessageType.ErrorMessage,message:"Unable to read message body."}),void t.completed();var I,S,E=function(t){var n=/https:\/\/teams\.microsoft\.com\/l\/meetup-join\/[^\s"<]+/i,a=/https:\/\/[^\/]+\.safelinks\.protection\.outlook\.com\/[^\s"<]+/i,o=/https:\/\/aka\.ms\/[^\s"<]*teams[^\s"<]*/i,r=function(t){var n=[],a=t.match(/https:\/\/teams\.microsoft\.com\/l\/meetup-join\/[^\s"'<>]+/gi);a&&n.push.apply(n,e(a));var o=function(e){return e.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'")}(t).match(/https:\/\/teams\.microsoft\.com\/l\/meetup-join\/[^\s"'<>]+/gi);o&&n.push.apply(n,e(o));for(var r=0;r<n.length;r+=1){var s=p(n[r]);if(s)return s}return null}(t);if(r)return r;for(var s=t.match(/https?:\/\/[^\s"'<>]+/gi)||[],i=0;i<s.length;i+=1){var c=s[i].replace(/&amp;/g,"&");if(n.test(c))return p(c);if(a.test(c)){var l=g(c);if(l){var m=p(l);if(n.test(m))return m}}if(o.test(c))return c}return null}(h.value);if(y("Teams link match",{found:Boolean(E)}),!E)return i(o,"No Microsoft Teams meeting link found in this invite."),void t.completed();y("Teams link extracted",{teamsLink:E}),I=function(e,u){if(!e)return s(o,"EWS health check failed: ".concat(u)),void t.completed();!function(e,t){var o=f(e);y("EWS FindItem by link request prepared");var r,s='<?xml version="1.0" encoding="utf-8"?>\n<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"\n               xmlns:t="'.concat(a,'"\n               xmlns:m="').concat(n,'">\n  <soap:Header>\n    <t:RequestServerVersion Version="Exchange2013" />\n  </soap:Header>\n  <soap:Body>\n    <m:FindItem Traversal="Shallow">\n      <m:ItemShape>\n        <t:BaseShape>IdOnly</t:BaseShape>\n      </m:ItemShape>\n      <m:CalendarView StartDate="').concat((r=new Date,r.setDate(r.getDate()-7),r.toISOString()),'" EndDate="').concat(function(){var e=new Date;return e.setDate(e.getDate()+90),e.toISOString()}(),'" />\n      <m:Restriction>\n        <t:Contains ContainmentMode="Substring" ContainmentComparison="IgnoreCase">\n          <t:FieldURI FieldURI="item:Body" />\n          <t:Constant Value="').concat(o,'" />\n        </t:Contains>\n      </m:Restriction>\n      <m:ParentFolderIds>\n        <t:DistinguishedFolderId Id="calendar" />\n      </m:ParentFolderIds>\n    </m:FindItem>\n  </soap:Body>\n</soap:Envelope>');Office.context.mailbox.makeEwsRequestAsync(s,function(e){if(y("EWS FindItem by link response",{status:e.status,error:e.error?{name:e.error.name,message:e.error.message}:null}),e.status===Office.AsyncResultStatus.Succeeded){var n=function(e){var t=d(e);if(!t)return null;var n=t.getElementsByTagNameNS(a,"ItemId")[0];return n?{id:n.getAttribute("Id"),changeKey:n.getAttribute("ChangeKey")}:null}(e.value);t(null,n)}else t(e.error,null)})}(E,function(e,u){if(y("Find by link",{error:Boolean(e),found:Boolean(u)}),e)return s(o,"EWS error: ".concat(v(e))),i(o,"Opening event dialog (calendar search blocked)."),c(o,E),void t.completed();u?l(u,E,function(e){e?s(o,"Unable to update the calendar location."):r(o),t.completed()}):function(e,t){e.start&&e.end&&e.start.getAsync&&e.end.getAsync?e.start.getAsync(function(n){n.status===Office.AsyncResultStatus.Succeeded?e.end.getAsync(function(e){if(e.status===Office.AsyncResultStatus.Succeeded){var a=new Date(n.value),o=new Date(e.value);Number.isNaN(a.valueOf())||Number.isNaN(o.valueOf())?t(null,null):t(null,{start:a,end:o})}else t(e.error,null)}):t(n.error,null)}):t(null,null)}(o,function(e,u){if(y("Message time range",{error:Boolean(e),hasRange:Boolean(u)}),e||!u)return i(o,"No matching calendar event found."),void t.completed();!function(e,t){var o=e.start.toISOString(),r=e.end.toISOString();y("EWS FindItem by time request prepared",{startIso:o,endIso:r});var s='<?xml version="1.0" encoding="utf-8"?>\n<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"\n               xmlns:t="'.concat(a,'"\n               xmlns:m="').concat(n,'">\n  <soap:Header>\n    <t:RequestServerVersion Version="Exchange2013" />\n  </soap:Header>\n  <soap:Body>\n    <m:FindItem Traversal="Shallow">\n      <m:ItemShape>\n        <t:BaseShape>IdOnly</t:BaseShape>\n        <t:AdditionalProperties>\n          <t:FieldURI FieldURI="calendar:Start" />\n          <t:FieldURI FieldURI="calendar:End" />\n        </t:AdditionalProperties>\n      </m:ItemShape>\n      <m:CalendarView StartDate="').concat(o,'" EndDate="').concat(r,'" />\n      <m:ParentFolderIds>\n        <t:DistinguishedFolderId Id="calendar" />\n      </m:ParentFolderIds>\n    </m:FindItem>\n  </soap:Body>\n</soap:Envelope>');Office.context.mailbox.makeEwsRequestAsync(s,function(n){if(y("EWS FindItem by time response",{status:n.status,error:n.error?{name:n.error.name,message:n.error.message}:null}),n.status===Office.AsyncResultStatus.Succeeded){var o=function(e,t){var n=d(e);if(!n)return null;for(var o=n.getElementsByTagNameNS(a,"CalendarItem"),r=0;r<o.length;r+=1){var s=o[r],i=s.getElementsByTagNameNS(a,"Start")[0],c=s.getElementsByTagNameNS(a,"End")[0],l=s.getElementsByTagNameNS(a,"ItemId")[0];if(i&&c&&l){var u=new Date(i.textContent),f=new Date(c.textContent);if(!Number.isNaN(u.valueOf())&&!Number.isNaN(f.valueOf())&&m(u,f,t))return{id:l.getAttribute("Id"),changeKey:l.getAttribute("ChangeKey")}}}return null}(n.value,e);t(null,o)}else t(n.error,null)})}(u,function(e,n){return y("Find by time",{error:Boolean(e),found:Boolean(n)}),e?(s(o,"EWS error: ".concat(v(e))),i(o,"Opening event dialog (calendar search blocked)."),c(o,E),void t.completed()):n?void l(n,E,function(e){e?s(o,"Unable to update the calendar location."):r(o),t.completed()}):(i(o,"No matching calendar event found. Opening event dialog."),c(o,E),void t.completed())})})})},S='<?xml version="1.0" encoding="utf-8"?>\n<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"\n               xmlns:t="'.concat(a,'"\n               xmlns:m="').concat(n,'">\n  <soap:Header>\n    <t:RequestServerVersion Version="Exchange2013" />\n  </soap:Header>\n  <soap:Body>\n    <m:GetFolder>\n      <m:FolderShape>\n        <t:BaseShape>IdOnly</t:BaseShape>\n      </m:FolderShape>\n      <m:FolderIds>\n        <t:DistinguishedFolderId Id="calendar" />\n      </m:FolderIds>\n    </m:GetFolder>\n  </soap:Body>\n</soap:Envelope>'),Office.context.mailbox.makeEwsRequestAsync(S,function(e){if(y("EWS health check response",{status:e.status,error:e.error?{name:e.error.name,message:e.error.message}:null}),e.status===Office.AsyncResultStatus.Succeeded){var t=d(e.value);t&&u(t)?I(!0,"OK"):I(!1,"EWS GetFolder failed.")}else I(!1,v(e.error))})})})}();
//# sourceMappingURL=commands.js.map